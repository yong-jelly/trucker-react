# ì¥ë¹„ ì‹œìŠ¤í…œ ì„¤ê³„ ë° êµ¬í˜„ TODO

## ğŸ“‹ ê°œìš”

ì¥ë¹„(Equipment) ì‹œìŠ¤í…œì„ í•˜ë“œì½”ë”©ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì „í™˜í•˜ê³ , ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•©ë‹ˆë‹¤.

---

## ğŸ¯ í•µì‹¬ ìš”êµ¬ì‚¬í•­

1. **ì¥ë¹„ ë§ˆìŠ¤í„° í…Œì´ë¸”** (`tbl_equipments`) - ëª¨ë“  ì¥ë¹„ ì •ì˜
2. **ìœ ì €-ì¥ë¹„ ë§µí•‘ í…Œì´ë¸”** (`tbl_user_equipments`) - ìœ ì €ê°€ ë³´ìœ í•œ ì¥ë¹„
3. **ê³„ì•½(Run) ìŠ¤ëƒ…ìƒ·** - ìš´í–‰ ì‹œì‘ ì‹œ ì¥ë¹„ ë©”íƒ€ ì •ë³´ë¥¼ Runì— ì €ì¥ (ë³€ê²½ ë¶ˆê°€)
4. **ê´€ë¦¬ì í˜ì´ì§€** - ì¥ë¹„ ëª©ë¡ ê´€ë¦¬, URL íƒ­ ê¸°ë°˜ (`?tab=equipment`)
5. **í´ë¼ì´ì–¸íŠ¸ í•˜ë“œì½”ë”© ì œê±°** - API ê¸°ë°˜ ë™ì‘

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### 1. tbl_equipments (ì¥ë¹„ ë§ˆìŠ¤í„° í…Œì´ë¸”)

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… | ê¸°ë³¸ê°’ |
|--------|------|------|--------|
| `id` | `text` | PK, ì¥ë¹„ ê³ ìœ  ID | - |
| `name` | `text` | ì¥ë¹„ ì´ë¦„ | - |
| `description` | `text` | ì¥ë¹„ ì„¤ëª… | - |
| `image_filename` | `text` | ì´ë¯¸ì§€ íŒŒì¼ëª… (ì˜ˆ: basic-bicycle) | - |
| `equipment_type` | `text` | íƒ€ì… (BICYCLE, VAN, TRUCK ë“±) | - |
| `price` | `bigint` | êµ¬ë§¤ ê°€ê²© ($) | 0 |
| `base_speed` | `float` | ê¸°ë³¸ ì†ë„ (km/h) | 15 |
| `max_speed` | `float` | ìµœëŒ€ ì†ë„ - ë¶€ìŠ¤íŠ¸ ì‹œ (km/h) | 25 |
| `max_weight` | `float` | ìµœëŒ€ ì ì¬ ë¬´ê²Œ (kg) | 10 |
| `max_volume` | `float` | ìµœëŒ€ ì ì¬ ë¶€í”¼ (L) | 20 |
| `allowed_categories` | `text[]` | í—ˆìš© ì¹´í…Œê³ ë¦¬ ë°°ì—´ | `{'CONVENIENCE'}` |
| `is_default` | `boolean` | ê¸°ë³¸ ì¥ë¹„ ì—¬ë¶€ (ì‹ ê·œ ìœ ì € ìë™ ì§€ê¸‰) | false |
| `is_active` | `boolean` | í™œì„±í™” ì—¬ë¶€ | true |
| `created_at` | `timestamptz` | ìƒì„±ì¼ | now() |
| `updated_at` | `timestamptz` | ìˆ˜ì •ì¼ | now() |

**ê¸°ë³¸ ë°ì´í„° (basic-bicycle)**:
- id: `basic-bicycle`
- name: `ê¸°ë³¸ ë°°ë‹¬ ìì „ê±°`
- image_filename: `basic-bicycle`
- equipment_type: `BICYCLE`
- price: `0`
- base_speed: `15`
- max_speed: `25`
- max_weight: `10`
- max_volume: `20`
- allowed_categories: `{'CONVENIENCE'}`
- is_default: `true`

### 2. tbl_user_equipments (ìœ ì €-ì¥ë¹„ ë§µí•‘ í…Œì´ë¸”)

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… | ê¸°ë³¸ê°’ |
|--------|------|------|--------|
| `id` | `uuid` | PK | uuid_generate_v4() |
| `user_id` | `uuid` | FK â†’ tbl_user_profile.public_profile_id | - |
| `equipment_id` | `text` | FK â†’ tbl_equipments.id | - |
| `purchased_at` | `timestamptz` | êµ¬ë§¤/íšë“ ì¼ì‹œ | now() |
| `is_equipped` | `boolean` | í˜„ì¬ ì¥ì°© ì—¬ë¶€ | false |

**UNIQUE ì œì•½**: `(user_id, equipment_id)` - ë™ì¼ ì¥ë¹„ ì¤‘ë³µ ë³´ìœ  ë¶ˆê°€

### 3. tbl_runs í™•ì¥ (ì¥ë¹„ ìŠ¤ëƒ…ìƒ· ì»¬ëŸ¼ ì¶”ê°€)

ê³„ì•½ ì‹¤í–‰ ì‹œ ì¥ë¹„ ì„¤ì •ê°’ì„ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥í•˜ì—¬, ì´í›„ ê´€ë¦¬ìê°€ ì„¤ì •ì„ ë³€ê²½í•´ë„ ì§„í–‰ ì¤‘ì¸ ê³„ì•½ì—ëŠ” ì˜í–¥ì´ ì—†ë„ë¡ í•©ë‹ˆë‹¤.

| ì¶”ê°€ ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|-------------|------|------|
| `equipment_snapshot` | `jsonb` | ê³„ì•½ ì‹œì ì˜ ì¥ë¹„ ë©”íƒ€ ì •ë³´ ìŠ¤ëƒ…ìƒ· |

**ìŠ¤ëƒ…ìƒ· êµ¬ì¡°**:
```json
{
  "id": "basic-bicycle",
  "name": "ê¸°ë³¸ ë°°ë‹¬ ìì „ê±°",
  "base_speed": 15,
  "max_speed": 25,
  "max_weight": 10,
  "max_volume": 20
}
```

---

## ğŸ”§ êµ¬í˜„ TODO ëª©ë¡

### Phase 1: ë°ì´í„°ë² ì´ìŠ¤ (SQL)

- [ ] **1.1** `tbl_equipments` í…Œì´ë¸” ìƒì„± SQL ì‘ì„±
- [ ] **1.2** `tbl_user_equipments` í…Œì´ë¸” ìƒì„± SQL ì‘ì„±
- [ ] **1.3** `tbl_runs`ì— `equipment_snapshot` ì»¬ëŸ¼ ì¶”ê°€ SQL ì‘ì„±
- [ ] **1.4** ê¸°ë³¸ ì¥ë¹„ ë°ì´í„° INSERT (basic-bicycle)
- [ ] **1.5** `handle_new_user()` íŠ¸ë¦¬ê±° ìˆ˜ì • - ì‹ ê·œ ìœ ì €ì—ê²Œ ê¸°ë³¸ ì¥ë¹„ ìë™ ì§€ê¸‰
- [ ] **1.6** ê¸°ì¡´ ìœ ì €ë“¤ì—ê²Œ ê¸°ë³¸ ì¥ë¹„ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL

### Phase 2: API í•¨ìˆ˜ (SQL RPC)

- [ ] **2.1** `v1_get_equipments()` - ì „ì²´ ì¥ë¹„ ëª©ë¡ ì¡°íšŒ
- [ ] **2.2** `v1_get_user_equipments(p_user_id)` - ìœ ì € ë³´ìœ  ì¥ë¹„ ì¡°íšŒ
- [ ] **2.3** `v1_update_equipment(p_id, ...)` - ì¥ë¹„ ì •ë³´ ìˆ˜ì • (ê´€ë¦¬ììš©)
- [ ] **2.4** `v1_create_run()` ìˆ˜ì • - ì¥ë¹„ ìŠ¤ëƒ…ìƒ· ì €ì¥ ë¡œì§ ì¶”ê°€

### Phase 3: í´ë¼ì´ì–¸íŠ¸ API ë ˆì´ì–´

- [ ] **3.1** `src/entities/equipment/api.ts` ìƒì„± - ì¥ë¹„ API í•¨ìˆ˜
- [ ] **3.2** `src/entities/equipment/queries.ts` ìƒì„± - React Query í›…
- [ ] **3.3** `src/entities/equipment/index.ts` ìƒì„± - ëª¨ë“ˆ export
- [ ] **3.4** `src/shared/api/equipment.ts` í•˜ë“œì½”ë”© ì œê±° ë˜ëŠ” í´ë°±ìš© ìœ ì§€

### Phase 4: ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ ìˆ˜ì • (OrderDetail.tsx)

- [ ] **4.1** í•˜ë“œì½”ë”©ëœ `EQUIPMENTS` import ì œê±°
- [ ] **4.2** `useUserEquipments()` í›…ìœ¼ë¡œ ìœ ì € ë³´ìœ  ì¥ë¹„ ì¡°íšŒ
- [ ] **4.3** ì¥ë¹„ ì„ íƒ UIì—ì„œ ë³´ìœ  ì¥ë¹„ë§Œ í‘œì‹œ
- [ ] **4.4** ì¥ë¹„ ì´ë¯¸ì§€ ë¡œë”© ë¡œì§ ìˆ˜ì • (DB image_filename ê¸°ë°˜)

### Phase 5: ê´€ë¦¬ì í˜ì´ì§€ (AdminSetting.tsx)

- [ ] **5.1** URL íƒ­ íŒŒë¼ë¯¸í„° ì§€ì› (`?tab=bot`, `?tab=enforcement`, `?tab=equipment`)
- [ ] **5.2** `EquipmentSettingsTab` ì»´í¬ë„ŒíŠ¸ ìƒì„±
- [ ] **5.3** ì¥ë¹„ ëª©ë¡ í…Œì´ë¸” UI (ì´ë¦„, íƒ€ì…, ê°€ê²©, ì†ë„ ë“±)
- [ ] **5.4** ì¥ë¹„ ìˆ˜ì • ëª¨ë‹¬/í¼ UI
- [ ] **5.5** ìˆ˜ì • ê°€ëŠ¥ í•„ë“œ: name, description, price, base_speed, max_speed, max_weight, max_volume, allowed_categories
- [ ] **5.6** ìˆ˜ì • ë¶ˆê°€ í•„ë“œ: id (ìœ ì € ë§µí•‘ì— ì‚¬ìš©ë¨)
- [ ] **5.7** ì €ì¥ ê¸°ëŠ¥ ì—°ë™

### Phase 6: ê³„ì•½(Run) ì‹œìŠ¤í…œ ì—°ë™

- [ ] **6.1** `createRun()` í•¨ìˆ˜ì—ì„œ ì¥ë¹„ ìŠ¤ëƒ…ìƒ· ì „ë‹¬
- [ ] **6.2** ê³„ì•½ì„œ ë‹¤ì´ì–¼ë¡œê·¸ì— ì¥ë¹„ ìƒì„¸ ì •ë³´ í‘œì‹œ (ìŠ¤ëƒ…ìƒ· ê¸°ë°˜)
- [ ] **6.3** ìš´í–‰ ì¤‘ í™”ë©´(ActiveRun)ì—ì„œ ìŠ¤ëƒ…ìƒ· ì •ë³´ ì‚¬ìš©

### Phase 7: í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

- [ ] **7.1** SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë° ê²€ì¦
- [ ] **7.2** ì‹ ê·œ ìœ ì € ê°€ì… ì‹œ ê¸°ë³¸ ì¥ë¹„ ìë™ ì§€ê¸‰ í™•ì¸
- [ ] **7.3** ì£¼ë¬¸ ìƒì„¸ â†’ ì¥ë¹„ ì„ íƒ â†’ ê³„ì•½ ì‹¤í–‰ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] **7.4** ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¥ë¹„ ìˆ˜ì • í›„ ê¸°ì¡´ ê³„ì•½ ì˜í–¥ ì—†ìŒ í™•ì¸
- [ ] **7.5** í´ë¼ì´ì–¸íŠ¸ í•˜ë“œì½”ë”© ì™„ì „ ì œê±° í™•ì¸

---

## ğŸ“ ì˜í–¥ë°›ëŠ” íŒŒì¼ ëª©ë¡

### SQL íŒŒì¼ (ì‹ ê·œ)
- `doc/sql/023_create_equipment_tables.sql`
- `doc/sql/024_equipment_api_functions.sql`

### í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ (ì‹ ê·œ)
- `src/entities/equipment/api.ts`
- `src/entities/equipment/queries.ts`
- `src/entities/equipment/index.ts`
- `src/widgets/admin/ui/EquipmentSettingsTab.tsx`

### í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ (ìˆ˜ì •)
- `src/shared/api/equipment.ts` â†’ í´ë°±ìš© ë˜ëŠ” ì œê±°
- `src/pages/OrderDetail.tsx` â†’ API ê¸°ë°˜ìœ¼ë¡œ ì „í™˜
- `src/pages/AdminSetting.tsx` â†’ íƒ­ ì¶”ê°€, URL íŒŒë¼ë¯¸í„° ì§€ì›
- `src/entities/run/api.ts` â†’ ìŠ¤ëƒ…ìƒ· ì²˜ë¦¬

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

1. **ID ë³€ê²½ ë¶ˆê°€**: `equipment_id`ëŠ” `tbl_user_equipments` ë° `tbl_runs`ì—ì„œ ì°¸ì¡°í•˜ë¯€ë¡œ ë³€ê²½ ë¶ˆê°€
2. **ìŠ¤ëƒ…ìƒ· ë¶ˆë³€ì„±**: ê³„ì•½ ì‹œì‘ í›„ `equipment_snapshot`ì€ ì ˆëŒ€ ìˆ˜ì •ë˜ì§€ ì•ŠìŒ
3. **ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ**: í…Œì´ë¸” ìƒì„± â†’ ê¸°ë³¸ ë°ì´í„° â†’ ê¸°ì¡´ ìœ ì € ë§ˆì´ê·¸ë ˆì´ì…˜ â†’ íŠ¸ë¦¬ê±° ìˆ˜ì •
4. **ì´ë¯¸ì§€ ê²½ë¡œ**: `src/shared/assets/images/{image_filename}.png` í˜•ì‹ìœ¼ë¡œ ë¡œë“œ

---

## ğŸš€ êµ¬í˜„ ìˆœì„œ (ê¶Œì¥)

1. **Phase 1** â†’ SQL í…Œì´ë¸” ë° ë°ì´í„° ì¤€ë¹„
2. **Phase 2** â†’ API RPC í•¨ìˆ˜ ìƒì„±
3. **Phase 3** â†’ í´ë¼ì´ì–¸íŠ¸ API ë ˆì´ì–´ êµ¬ì¶•
4. **Phase 4** â†’ ì£¼ë¬¸ ìƒì„¸ í˜ì´ì§€ ìˆ˜ì •
5. **Phase 5** â†’ ê´€ë¦¬ì í˜ì´ì§€ íƒ­ ì¶”ê°€
6. **Phase 6** â†’ ê³„ì•½ ì‹œìŠ¤í…œ ì—°ë™
7. **Phase 7** â†’ í…ŒìŠ¤íŠ¸ ë° ê²€ì¦

---

## ğŸ“ í˜„ì¬ ì§„í–‰ ìƒíƒœ

| Phase | ìƒíƒœ | ë¹„ê³  |
|-------|------|------|
| Phase 1 | âœ… ì™„ë£Œ | í…Œì´ë¸” ìƒì„±, ê¸°ë³¸ ë°ì´í„°, ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ |
| Phase 2 | âœ… ì™„ë£Œ | RPC í•¨ìˆ˜ ìƒì„± ì™„ë£Œ |
| Phase 3 | âœ… ì™„ë£Œ | í´ë¼ì´ì–¸íŠ¸ API ë ˆì´ì–´ ì™„ë£Œ |
| Phase 4 | âœ… ì™„ë£Œ | OrderDetail.tsx ìˆ˜ì • ì™„ë£Œ |
| Phase 5 | âœ… ì™„ë£Œ | AdminSetting.tsx ì¥ë¹„ íƒ­ ì¶”ê°€ ì™„ë£Œ |
| Phase 6 | âœ… ì™„ë£Œ | SQL ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì™„ë£Œ (8ëª… ìœ ì € ê¸°ë³¸ ì¥ë¹„ ì§€ê¸‰) |
| Phase 7 | â³ ëŒ€ê¸° | í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ |
